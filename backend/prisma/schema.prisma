// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  calendarToken String? @unique @default(uuid())
  createdAt DateTime @default(now())

  tasks           Task[]
  timerSessions   TimerSession[]
  wakeLogs        WakeLog[]
  recurringRules  RecurringRule[]
  checklistInstances ChecklistInstance[]
  settings        Settings?
  quickMessages   QuickChatMessage[]
}

model Task {
  id                   String   @id @default(uuid())
  userId               String
  name                 String
  type                 String   // 'stopwatch', 'timer', 'checklist'
  category             String?
  memo                 String?
  isFavorite           Boolean  @default(false)
  isArchived           Boolean  @default(false)
  idleMonitorEnabled   Boolean  @default(false)
  defaultTimerDurationSec Int?
  plannedDate          DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user               User                @relation(fields: [userId], references: [id])
  timerSessions      TimerSession[]
  recurringRules     RecurringRule[]
  checklistInstances ChecklistInstance[]
}

model TimerSession {
  id                String   @id @default(uuid())
  userId            String
  taskId            String
  mode              String   // 'stopwatch', 'countdown'
  plannedDurationSec Int?
  startAt           DateTime
  endAt             DateTime?
  startMemo         String?
  endMemo           String?
  durationSec       Int?
  endReason         String?  // 'manual_stop', 'auto_complete', 'switch', 'edited'
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  task Task @relation(fields: [taskId], references: [id])
}

model WakeLog {
  id        String   @id @default(uuid())
  userId    String
  date      String   // YYYY-MM-DD
  wakeAt    DateTime
  isRestDay Boolean  @default(false)
  warned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model RecurringRule {
  id                 String   @id @default(uuid())
  userId             String
  taskId             String
  ruleType           String   // 'daily', 'weekly', 'monthly', 'yearly', 'interval'
  payload            String?  // JSON
  reminderEnabled    Boolean  @default(false)
  reminderStartTime  String?  // HH:mm
  reminderIntervalMin Int?
  reminderEndTime    String?  // HH:mm
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  task Task @relation(fields: [taskId], references: [id])
}

model ChecklistInstance {
  id              String   @id @default(uuid())
  userId          String
  taskId          String
  recurringRuleId String?
  dueAt           DateTime?
  status          String   // 'pending', 'done'
  completedAt     DateTime?
  memo            String?
  lastActivityAt  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  task Task @relation(fields: [taskId], references: [id])
}

model Settings {
  id                      String @id @default(uuid())
  userId                  String @unique
  wakeWarningTime         String @default("10:00")
  restDayMode             String? // JSON
  timerElapsedRemindMin   Int?
  timerElapsedRemindRepeat Boolean @default(false)
  timerLongDurationHours  Int     @default(6)
  idleThresholdDays       Int     @default(7)
  idleRepeatPolicy        String  @default("daily")
  silentHoursStart        String  @default("22:00")
  silentHoursEnd          String  @default("07:00")
  appLockEnabled          Boolean @default(false)

  user User @relation(fields: [userId], references: [id])
}

model QuickChatMessage {
  id                String   @id @default(uuid())
  userId            String
  role              String   // 'user', 'system'
  content           String
  relatedEntityType String?
  relatedEntityId   String?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
